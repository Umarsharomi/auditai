<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AuditAI â€” Smart Contract Security Scanner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap');

  :root {
    --bg: #050A0E;
    --surface: #0C1419;
    --surface2: #111D24;
    --border: #1A2A35;
    --accent: #00FF88;
    --accent2: #00C4FF;
    --danger: #FF4560;
    --warn: #FFB800;
    --text: #E0EEF5;
    --muted: #4A6070;
    --font-display: 'Syne', sans-serif;
    --font-mono: 'Space Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    top: -200px; right: -200px;
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(0,196,255,0.06) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 24px;
    position: relative;
    z-index: 1;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    padding: 28px 0 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 40px;
  }

  .header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; color: var(--accent);
    clip-path: polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
    background: rgba(0,255,136,0.08);
    border: 1px solid rgba(0,255,136,0.3);
  }

  .logo-text {
    font-family: var(--font-display);
    font-size: 22px; font-weight: 800; letter-spacing: -0.5px;
  }
  .logo-text span { color: var(--accent); }

  .header-right { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }

  /* Wallet button */
  .wallet-btn {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 16px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 11px; letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }
  .wallet-btn:hover { border-color: var(--accent2); color: var(--accent2); }
  .wallet-btn.connected { border-color: var(--accent); color: var(--accent); }

  .wallet-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--muted);
    transition: background 0.3s;
  }
  .wallet-btn.connected .wallet-dot { background: var(--accent); animation: pulse 2s infinite; }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .history-btn {
    display: flex; align-items: center; gap: 6px;
    padding: 8px 16px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: var(--font-mono);
    font-size: 11px; letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }
  .history-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  .badge {
    font-size: 10px; padding: 3px 8px;
    border: 1px solid var(--accent);
    color: var(--accent);
    letter-spacing: 2px; text-transform: uppercase;
  }

  /* â”€â”€ Hero â”€â”€ */
  .hero { text-align: center; margin-bottom: 40px; }

  .hero h1 {
    font-family: var(--font-display);
    font-size: clamp(28px, 5vw, 52px);
    font-weight: 800; line-height: 1.1;
    margin-bottom: 14px; letter-spacing: -1px;
  }
  .hero h1 .highlight { color: var(--accent); }

  .hero p { color: var(--muted); font-size: 13px; max-width: 480px; margin: 0 auto; line-height: 1.8; }

  .stats-row {
    display: flex; justify-content: center; gap: 40px;
    margin-top: 28px; padding-top: 28px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .stat { text-align: center; }
  .stat-num { font-family: var(--font-display); font-size: 22px; font-weight: 800; color: var(--accent); }
  .stat-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-top: 3px; }

  /* â”€â”€ Panel â”€â”€ */
  .panel { background: var(--surface); border: 1px solid var(--border); overflow: hidden; }

  .panel-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
  }

  .panel-title {
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
    color: var(--muted); display: flex; align-items: center; gap: 8px;
  }
  .panel-title .dot-live {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent); animation: pulse 2s infinite;
  }

  .dot-row { display: flex; gap: 6px; }
  .dot { width: 10px; height: 10px; border-radius: 50%; }
  .dot.red { background: #FF5F57; }
  .dot.yellow { background: #FFBD2E; }
  .dot.green { background: #28C840; }

  textarea {
    width: 100%; min-height: 300px;
    background: transparent; border: none; outline: none;
    color: var(--accent2);
    font-family: var(--font-mono); font-size: 13px; line-height: 1.8;
    padding: 18px; resize: vertical; tab-size: 2;
  }
  textarea::placeholder { color: var(--muted); }

  .example-bar {
    padding: 10px 18px; border-top: 1px solid var(--border);
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  }
  .example-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
  .example-btn {
    font-family: var(--font-mono); font-size: 10px; padding: 4px 10px;
    background: transparent; border: 1px solid var(--border); color: var(--muted);
    cursor: pointer; transition: all 0.2s; letter-spacing: 1px;
  }
  .example-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ Audit button â”€â”€ */
  .audit-btn {
    width: 100%; padding: 16px;
    background: var(--accent); color: var(--bg);
    border: none;
    font-family: var(--font-display); font-size: 15px; font-weight: 700;
    letter-spacing: 1px; cursor: pointer;
    transition: all 0.2s; text-transform: uppercase;
    margin-top: 2px;
  }
  .audit-btn:hover { background: #00e07a; transform: translateY(-1px); box-shadow: 0 8px 30px rgba(0,255,136,0.25); }
  .audit-btn:disabled { background: var(--surface2); color: var(--muted); cursor: not-allowed; transform: none; box-shadow: none; }

  .btn-inner { display: flex; align-items: center; justify-content: center; gap: 10px; }
  .loader { display: none; align-items: center; gap: 8px; }
  .loader.active { display: flex; }
  .spinner {
    width: 14px; height: 14px;
    border: 2px solid var(--bg); border-top-color: transparent;
    border-radius: 50%; animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Results â”€â”€ */
  #results { display: none; margin-top: 28px; animation: fadeIn 0.5s ease; }
  #results.visible { display: block; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

  .score-card {
    background: var(--surface); border: 1px solid var(--border);
    padding: 28px; margin-bottom: 20px;
    display: flex; align-items: center; gap: 28px; flex-wrap: wrap;
  }

  .score-circle {
    width: 96px; height: 96px; border-radius: 50%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    border: 3px solid; flex-shrink: 0;
  }
  .score-circle.high { border-color: var(--accent); color: var(--accent); }
  .score-circle.medium { border-color: var(--warn); color: var(--warn); }
  .score-circle.low { border-color: var(--danger); color: var(--danger); }

  .score-num { font-family: var(--font-display); font-size: 30px; font-weight: 800; line-height: 1; }
  .score-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; margin-top: 3px; }

  .score-info { flex: 1; min-width: 200px; }
  .score-title { font-family: var(--font-display); font-size: 20px; font-weight: 700; margin-bottom: 6px; }
  .score-summary { color: var(--muted); font-size: 12px; line-height: 1.8; }

  .severity-pills { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
  .pill { font-size: 10px; padding: 3px 10px; letter-spacing: 1px; text-transform: uppercase; border: 1px solid; }
  .pill.critical { border-color: var(--danger); color: var(--danger); background: rgba(255,69,96,0.08); }
  .pill.high { border-color: var(--warn); color: var(--warn); background: rgba(255,184,0,0.08); }
  .pill.medium { border-color: var(--accent2); color: var(--accent2); background: rgba(0,196,255,0.08); }
  .pill.low { border-color: var(--muted); color: var(--muted); }

  /* Share bar */
  .share-bar {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 16px;
    background: var(--surface2); border: 1px solid var(--border);
    margin-bottom: 20px; flex-wrap: wrap;
  }
  .share-label { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; white-space: nowrap; }
  .share-link {
    flex: 1; min-width: 120px;
    background: var(--bg); border: 1px solid var(--border);
    color: var(--accent2); font-family: var(--font-mono); font-size: 11px;
    padding: 6px 10px; outline: none;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .copy-btn {
    padding: 6px 14px;
    background: transparent; border: 1px solid var(--accent);
    color: var(--accent); font-family: var(--font-mono); font-size: 10px;
    letter-spacing: 1px; cursor: pointer; transition: all 0.2s; white-space: nowrap;
    text-transform: uppercase;
  }
  .copy-btn:hover { background: rgba(0,255,136,0.1); }
  .copy-btn.copied { border-color: var(--accent2); color: var(--accent2); }

  .summary-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 14px; margin-bottom: 20px;
  }
  .summary-card { background: var(--surface); border: 1px solid var(--border); padding: 16px; }
  .summary-card-title { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .summary-card-value { font-family: var(--font-display); font-size: 20px; font-weight: 700; color: var(--accent); }

  .findings-grid { display: grid; gap: 14px; margin-bottom: 20px; }

  .finding {
    background: var(--surface); border: 1px solid var(--border); border-left: 3px solid;
    padding: 18px; transition: transform 0.2s;
  }
  .finding:hover { transform: translateX(3px); }
  .finding.critical { border-left-color: var(--danger); }
  .finding.high { border-left-color: var(--warn); }
  .finding.medium { border-left-color: var(--accent2); }
  .finding.low { border-left-color: var(--muted); }

  .finding-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
  .finding-severity { font-size: 9px; padding: 2px 7px; letter-spacing: 2px; text-transform: uppercase; border: 1px solid currentColor; }
  .finding.critical .finding-severity { color: var(--danger); }
  .finding.high .finding-severity { color: var(--warn); }
  .finding.medium .finding-severity { color: var(--accent2); }
  .finding.low .finding-severity { color: var(--muted); }
  .finding-title { font-family: var(--font-display); font-size: 14px; font-weight: 700; }
  .finding-desc { color: var(--muted); font-size: 12px; line-height: 1.8; margin-bottom: 10px; }
  .finding-rec {
    background: var(--surface2); border: 1px solid var(--border);
    padding: 10px 14px; font-size: 12px; color: var(--accent); line-height: 1.8;
  }
  .finding-rec::before { content: 'â†’ FIX: '; opacity: 0.6; }

  .action-row { display: flex; gap: 12px; flex-wrap: wrap; }
  .action-btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 10px 20px; background: transparent;
    border: 1px solid var(--border); color: var(--muted);
    font-family: var(--font-mono); font-size: 11px; letter-spacing: 1px;
    cursor: pointer; transition: all 0.2s; text-transform: uppercase;
  }
  .action-btn:hover { border-color: var(--accent); color: var(--accent); }
  .action-btn.primary { border-color: var(--accent2); color: var(--accent2); }
  .action-btn.primary:hover { background: rgba(0,196,255,0.08); }

  /* â”€â”€ History Drawer â”€â”€ */
  .drawer-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.7); z-index: 100;
    backdrop-filter: blur(4px);
  }
  .drawer-overlay.open { display: block; }

  .drawer {
    position: fixed; top: 0; right: -440px; bottom: 0; width: 420px;
    background: var(--surface); border-left: 1px solid var(--border);
    z-index: 101; transition: right 0.3s ease;
    display: flex; flex-direction: column;
    overflow: hidden;
  }
  .drawer.open { right: 0; }

  .drawer-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2); flex-shrink: 0;
  }
  .drawer-title { font-family: var(--font-display); font-size: 16px; font-weight: 700; }
  .drawer-close {
    background: transparent; border: 1px solid var(--border);
    color: var(--muted); width: 32px; height: 32px;
    cursor: pointer; font-size: 16px; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
  }
  .drawer-close:hover { border-color: var(--danger); color: var(--danger); }

  .drawer-body { flex: 1; overflow-y: auto; padding: 16px; }

  .history-empty {
    text-align: center; padding: 60px 20px;
    color: var(--muted); font-size: 12px; line-height: 2;
  }
  .history-empty .big { font-size: 32px; display: block; margin-bottom: 12px; }

  .history-item {
    background: var(--surface2); border: 1px solid var(--border);
    padding: 14px 16px; margin-bottom: 10px;
    cursor: pointer; transition: all 0.2s;
  }
  .history-item:hover { border-color: var(--accent2); transform: translateX(-3px); }

  .history-item-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
  .history-score { font-family: var(--font-display); font-size: 18px; font-weight: 800; }
  .history-score.high { color: var(--accent); }
  .history-score.medium { color: var(--warn); }
  .history-score.low { color: var(--danger); }
  .history-date { font-size: 10px; color: var(--muted); }
  .history-verdict { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
  .history-snippet { font-size: 11px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .history-del {
    float: right; background: transparent; border: none;
    color: var(--muted); cursor: pointer; font-size: 12px; padding: 2px 6px;
    transition: color 0.2s;
  }
  .history-del:hover { color: var(--danger); }

  .drawer-footer {
    padding: 14px 24px; border-top: 1px solid var(--border);
    background: var(--surface2); flex-shrink: 0;
  }
  .clear-btn {
    width: 100%; padding: 9px;
    background: transparent; border: 1px solid var(--border);
    color: var(--muted); font-family: var(--font-mono); font-size: 11px;
    letter-spacing: 1px; cursor: pointer; transition: all 0.2s; text-transform: uppercase;
  }
  .clear-btn:hover { border-color: var(--danger); color: var(--danger); }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: var(--surface2); border: 1px solid var(--accent);
    color: var(--accent); font-size: 12px; letter-spacing: 1px;
    padding: 10px 20px; opacity: 0; transition: all 0.3s; z-index: 200;
    pointer-events: none; white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* â”€â”€ Error â”€â”€ */
  .error-box {
    display: none; padding: 14px 18px;
    border: 1px solid var(--danger); background: rgba(255,69,96,0.08);
    color: var(--danger); font-size: 12px; margin-top: 14px;
  }
  .error-box.visible { display: block; }

  /* â”€â”€ Footer â”€â”€ */
  footer {
    margin-top: 70px; padding: 28px 0;
    border-top: 1px solid var(--border);
    text-align: center; color: var(--muted); font-size: 10px; letter-spacing: 1px;
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); }

  @media (max-width: 600px) {
    .stats-row { gap: 20px; }
    .score-card { flex-direction: column; }
    .drawer { width: 100%; right: -100%; }
  }
</style>
</head>
<body>

<!-- History Drawer -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeHistory()"></div>
<div class="drawer" id="historyDrawer">
  <div class="drawer-header">
    <div class="drawer-title">Audit History</div>
    <button class="drawer-close" onclick="closeHistory()">âœ•</button>
  </div>
  <div class="drawer-body" id="historyBody"></div>
  <div class="drawer-footer">
    <button class="clear-btn" onclick="clearHistory()">Clear All History</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<div class="container">

  <header>
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon">â¬¡</div>
        <div class="logo-text">Audit<span>AI</span></div>
      </div>
      <div class="header-right">
        <button class="history-btn" onclick="openHistory()">
          â˜° History <span id="historyCount" style="color:var(--accent)"></span>
        </button>
        <button class="wallet-btn" id="walletBtn" onclick="connectWallet()">
          <div class="wallet-dot" id="walletDot"></div>
          <span id="walletLabel">Connect Wallet</span>
        </button>
        <div class="badge">Beta v0.2</div>
      </div>
    </div>
  </header>

  <div class="hero">
    <h1>Smart Contract<br><span class="highlight">Security Scanner</span></h1>
    <p>Paste your Solidity code and get an instant AI-powered security audit. Detect vulnerabilities before deployment.</p>
    <div class="stats-row">
      <div class="stat"><div class="stat-num">20+</div><div class="stat-label">Vuln Checks</div></div>
      <div class="stat"><div class="stat-num">&lt;30s</div><div class="stat-label">Audit Time</div></div>
      <div class="stat"><div class="stat-num">Free</div><div class="stat-label">Always</div></div>
      <div class="stat"><div class="stat-num" id="totalAudits">0</div><div class="stat-label">Audits Run</div></div>
    </div>
  </div>

  <div class="panel" style="margin-bottom:2px">
    <div class="panel-header">
      <div class="panel-title"><span class="dot-live"></span> Solidity Contract</div>
      <div class="dot-row">
        <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
      </div>
    </div>
    <textarea id="contractCode" placeholder="// Paste your Solidity smart contract here...&#10;// Example:&#10;// pragma solidity ^0.8.0;&#10;// contract MyToken { ... }"></textarea>
    <div class="example-bar">
      <span class="example-label">Load example:</span>
      <button class="example-btn" onclick="loadExample('erc20')">ERC20 Token</button>
      <button class="example-btn" onclick="loadExample('reentrancy')">Reentrancy Bug</button>
      <button class="example-btn" onclick="loadExample('overflow')">Overflow Bug</button>
    </div>
  </div>

  <button class="audit-btn" id="auditBtn" onclick="runAudit()">
    <div class="btn-inner" id="btnText">â¬¡ Run Security Audit</div>
    <div class="loader" id="btnLoader"><div class="spinner"></div> Analyzing contract...</div>
  </button>

  <div class="error-box" id="errorBox"></div>

  <!-- Results -->
  <div id="results">
    <div class="score-card" id="scoreCard"></div>
    <div class="share-bar" id="shareBar" style="display:none">
      <span class="share-label">Share:</span>
      <input class="share-link" id="shareLink" readonly />
      <button class="copy-btn" id="copyBtn" onclick="copyShareLink()">Copy Link</button>
    </div>
    <div class="summary-grid" id="summaryGrid"></div>
    <div class="panel-header" style="margin-bottom:14px; background:var(--surface); border:1px solid var(--border);">
      <div class="panel-title">Security Findings</div>
    </div>
    <div class="findings-grid" id="findingsGrid"></div>
    <div class="action-row">
      <button class="action-btn primary" onclick="downloadReport()">â†“ Download Report</button>
      <button class="action-btn" onclick="copyShareLink()">âŽ˜ Copy Share Link</button>
    </div>
  </div>

</div>

<footer>
  <div class="container">
    AuditAI v0.2 â€” AI-Powered Smart Contract Scanner &nbsp;Â·&nbsp; Not a replacement for professional audits &nbsp;Â·&nbsp; Free forever
  </div>
</footer>

<script>
// â”€â”€â”€ Examples â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EXAMPLES = {
  erc20: `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SimpleToken {
    string public name = "SimpleToken";
    string public symbol = "STK";
    uint256 public totalSupply;
    mapping(address => uint256) public balanceOf;
    mapping(address => mapping(address => uint256)) public allowance;
    address public owner;

    constructor(uint256 _supply) {
        owner = msg.sender;
        totalSupply = _supply;
        balanceOf[msg.sender] = _supply;
    }

    function transfer(address to, uint256 amount) public returns (bool) {
        require(balanceOf[msg.sender] >= amount, "Insufficient balance");
        balanceOf[msg.sender] -= amount;
        balanceOf[to] += amount;
        return true;
    }

    function mint(uint256 amount) public {
        // No access control!
        totalSupply += amount;
        balanceOf[msg.sender] += amount;
    }
}`,
  reentrancy: `// SPDX-License-Identifier: MIT
pragma solidity ^0.6.0;

contract VulnerableBank {
    mapping(address => uint256) public balances;

    function deposit() public payable {
        balances[msg.sender] += msg.value;
    }

    function withdraw() public {
        uint256 amount = balances[msg.sender];
        require(amount > 0, "No balance");
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");
        balances[msg.sender] = 0; // Too late!
    }
}`,
  overflow: `// SPDX-License-Identifier: MIT
pragma solidity ^0.6.0;

contract VulnerableToken {
    mapping(address => uint256) public balances;
    constructor() public { balances[msg.sender] = 1000; }

    function batchTransfer(address[] memory receivers, uint256 value) public {
        uint256 amount = receivers.length * value; // OVERFLOW
        require(balances[msg.sender] >= amount);
        balances[msg.sender] -= amount;
        for (uint i = 0; i < receivers.length; i++) {
            balances[receivers[i]] += value;
        }
    }
}`
};

function loadExample(type) {
  document.getElementById('contractCode').value = EXAMPLES[type];
}

// â”€â”€â”€ Storage helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getHistory() {
  try { return JSON.parse(localStorage.getItem('auditHistory') || '[]'); } catch { return []; }
}
function saveHistory(h) {
  try { localStorage.setItem('auditHistory', JSON.stringify(h.slice(0, 50))); } catch {}
}
function updateHistoryCount() {
  const h = getHistory();
  const el = document.getElementById('historyCount');
  el.textContent = h.length > 0 ? `(${h.length})` : '';
  document.getElementById('totalAudits').textContent = h.length;
}

// â”€â”€â”€ Wallet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let walletAddress = null;

async function connectWallet() {
  if (walletAddress) {
    // Disconnect
    walletAddress = null;
    const btn = document.getElementById('walletBtn');
    btn.classList.remove('connected');
    document.getElementById('walletLabel').textContent = 'Connect Wallet';
    showToast('Wallet disconnected');
    return;
  }

  if (!window.ethereum) {
    showToast('MetaMask not detected. Please install it.');
    return;
  }

  try {
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    walletAddress = accounts[0];
    const short = walletAddress.slice(0, 6) + '...' + walletAddress.slice(-4);
    document.getElementById('walletBtn').classList.add('connected');
    document.getElementById('walletLabel').textContent = short;
    showToast('Wallet connected: ' + short);
  } catch (e) {
    showToast('Connection rejected.');
  }
}

// â”€â”€â”€ Share link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastAuditData = null;
let lastAuditId = null;

function generateShareLink(auditId) {
  return window.location.origin + window.location.pathname + '?audit=' + auditId;
}

function copyShareLink() {
  const link = document.getElementById('shareLink').value;
  if (!link) return;
  navigator.clipboard.writeText(link).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.textContent = 'âœ“ Copied!';
    btn.classList.add('copied');
    showToast('Share link copied!');
    setTimeout(() => { btn.textContent = 'Copy Link'; btn.classList.remove('copied'); }, 2000);
  });
}

// â”€â”€â”€ Main audit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAudit() {
  const code = document.getElementById('contractCode').value.trim();
  if (!code) { showError('Please paste a Solidity contract first.'); return; }

  const btn = document.getElementById('auditBtn');
  const btnText = document.getElementById('btnText');
  const btnLoader = document.getElementById('btnLoader');

  btn.disabled = true;
  btnText.style.display = 'none';
  btnLoader.classList.add('active');
  document.getElementById('errorBox').classList.remove('visible');
  document.getElementById('results').style.display = 'none';

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{
          role: 'user',
          content: `You are a senior smart contract security auditor. Analyze this Solidity contract and return ONLY a valid JSON object. No markdown, no backticks, no extra text.

Contract:
${code}

Return this exact JSON:
{
  "score": <0-100>,
  "verdict": "<SECURE|MODERATE RISK|HIGH RISK|CRITICAL>",
  "summary": "<2 sentence summary>",
  "findings": [
    {
      "severity": "<CRITICAL|HIGH|MEDIUM|LOW>",
      "title": "<name>",
      "description": "<what and where>",
      "recommendation": "<how to fix>"
    }
  ],
  "stats": {
    "lines": <number>,
    "functions": <number>,
    "checks_performed": <number>,
    "audit_time": "<Xs>"
  }
}`
        }]
      })
    });

    const data = await response.json();
    const text = data.content[0].text;
    const clean = text.replace(/```json|```/g, '').trim();
    const audit = JSON.parse(clean);

    lastAuditData = audit;
    lastAuditId = 'audit_' + Date.now();

    // Save to history
    const history = getHistory();
    history.unshift({
      id: lastAuditId,
      date: new Date().toISOString(),
      score: audit.score,
      verdict: audit.verdict,
      summary: audit.summary,
      findings: audit.findings,
      stats: audit.stats,
      codeSnippet: code.slice(0, 80) + '...',
      wallet: walletAddress || null
    });
    saveHistory(history);
    updateHistoryCount();

    renderResults(audit, lastAuditId);

  } catch (err) {
    showError('Audit failed: ' + err.message);
  } finally {
    btn.disabled = false;
    btnText.style.display = 'flex';
    btnLoader.classList.remove('active');
  }
}

// â”€â”€â”€ Render results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(audit, auditId) {
  const scoreClass = audit.score >= 70 ? 'high' : audit.score >= 40 ? 'medium' : 'low';
  const verdictColor = audit.verdict === 'SECURE' ? 'var(--accent)' :
                       audit.verdict === 'MODERATE RISK' ? 'var(--warn)' : 'var(--danger)';

  const critCount = audit.findings.filter(f => f.severity === 'CRITICAL').length;
  const highCount = audit.findings.filter(f => f.severity === 'HIGH').length;
  const medCount  = audit.findings.filter(f => f.severity === 'MEDIUM').length;
  const lowCount  = audit.findings.filter(f => f.severity === 'LOW').length;

  document.getElementById('scoreCard').innerHTML = `
    <div class="score-circle ${scoreClass}">
      <div class="score-num">${audit.score}</div>
      <div class="score-label">/ 100</div>
    </div>
    <div class="score-info">
      <div class="score-title" style="color:${verdictColor}">${audit.verdict}</div>
      <div class="score-summary">${audit.summary}</div>
      <div class="severity-pills">
        ${critCount > 0 ? `<span class="pill critical">${critCount} Critical</span>` : ''}
        ${highCount > 0 ? `<span class="pill high">${highCount} High</span>` : ''}
        ${medCount  > 0 ? `<span class="pill medium">${medCount} Medium</span>` : ''}
        ${lowCount  > 0 ? `<span class="pill low">${lowCount} Low</span>` : ''}
        ${audit.findings.length === 0 ? '<span class="pill low">No issues found</span>' : ''}
      </div>
    </div>
  `;

  // Share bar
  const shareLink = generateShareLink(auditId);
  document.getElementById('shareLink').value = shareLink;
  document.getElementById('shareBar').style.display = 'flex';

  document.getElementById('summaryGrid').innerHTML = `
    <div class="summary-card">
      <div class="summary-card-title">Lines of Code</div>
      <div class="summary-card-value">${audit.stats.lines}</div>
    </div>
    <div class="summary-card">
      <div class="summary-card-title">Functions</div>
      <div class="summary-card-value">${audit.stats.functions}</div>
    </div>
    <div class="summary-card">
      <div class="summary-card-title">Checks</div>
      <div class="summary-card-value">${audit.stats.checks_performed}</div>
    </div>
    <div class="summary-card">
      <div class="summary-card-title">Issues Found</div>
      <div class="summary-card-value" style="color:${audit.findings.length > 0 ? 'var(--danger)' : 'var(--accent)'}">${audit.findings.length}</div>
    </div>
  `;

  document.getElementById('findingsGrid').innerHTML = audit.findings.length === 0
    ? `<div class="finding low" style="border-left-color:var(--accent)">
         <div class="finding-header">
           <span class="finding-severity" style="color:var(--accent)">CLEAN</span>
           <span class="finding-title">No vulnerabilities detected</span>
         </div>
         <div class="finding-desc">The contract passed all security checks. Always consider a professional audit before mainnet deployment.</div>
       </div>`
    : audit.findings.map(f => `
        <div class="finding ${f.severity.toLowerCase()}">
          <div class="finding-header">
            <span class="finding-severity">${f.severity}</span>
            <span class="finding-title">${f.title}</span>
          </div>
          <div class="finding-desc">${f.description}</div>
          <div class="finding-rec">${f.recommendation}</div>
        </div>
      `).join('');

  const resultsEl = document.getElementById('results');
  resultsEl.style.display = 'block';
  resultsEl.style.animation = 'none';
  resultsEl.offsetHeight; // reflow
  resultsEl.style.animation = '';
  resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// â”€â”€â”€ History drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openHistory() {
  renderHistoryDrawer();
  document.getElementById('historyDrawer').classList.add('open');
  document.getElementById('drawerOverlay').classList.add('open');
}

function closeHistory() {
  document.getElementById('historyDrawer').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('open');
}

function renderHistoryDrawer() {
  const history = getHistory();
  const body = document.getElementById('historyBody');

  if (history.length === 0) {
    body.innerHTML = `<div class="history-empty">
      <span class="big">ðŸ“‹</span>
      No audits yet.<br>Run your first audit to see history here.
    </div>`;
    return;
  }

  body.innerHTML = history.map((item, i) => {
    const scoreClass = item.score >= 70 ? 'high' : item.score >= 40 ? 'medium' : 'low';
    const date = new Date(item.date).toLocaleDateString('en-GB', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
    return `
      <div class="history-item" onclick="loadFromHistory(${i})">
        <div class="history-item-top">
          <span class="history-score ${scoreClass}">${item.score}/100</span>
          <span class="history-date">${date}</span>
          <button class="history-del" onclick="deleteHistory(event,${i})">âœ•</button>
        </div>
        <div class="history-verdict" style="color:${item.score>=70?'var(--accent)':item.score>=40?'var(--warn)':'var(--danger)'}">${item.verdict}</div>
        <div class="history-snippet">${item.codeSnippet}</div>
      </div>
    `;
  }).join('');
}

function loadFromHistory(index) {
  const history = getHistory();
  const item = history[index];
  if (!item) return;
  lastAuditData = item;
  lastAuditId = item.id;
  renderResults(item, item.id);
  closeHistory();
}

function deleteHistory(e, index) {
  e.stopPropagation();
  const history = getHistory();
  history.splice(index, 1);
  saveHistory(history);
  updateHistoryCount();
  renderHistoryDrawer();
  showToast('Audit removed');
}

function clearHistory() {
  if (!confirm('Clear all audit history?')) return;
  saveHistory([]);
  updateHistoryCount();
  renderHistoryDrawer();
  showToast('History cleared');
}

// â”€â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadReport() {
  if (!lastAuditData) return;
  const d = lastAuditData;
  const date = new Date().toISOString().split('T')[0];
  let report = `AUDITAI SMART CONTRACT SECURITY REPORT
Generated: ${date}
Wallet: ${walletAddress || 'Not connected'}
Share Link: ${lastAuditId ? generateShareLink(lastAuditId) : 'N/A'}
${'='.repeat(50)}

SECURITY SCORE: ${d.score}/100
VERDICT: ${d.verdict}

SUMMARY:
${d.summary}

STATISTICS:
- Lines of Code: ${d.stats.lines}
- Functions: ${d.stats.functions}
- Checks Performed: ${d.stats.checks_performed}
- Total Issues: ${d.findings.length}

${'='.repeat(50)}
FINDINGS
${'='.repeat(50)}
`;
  if (d.findings.length === 0) {
    report += '\nNo vulnerabilities detected.\n';
  } else {
    d.findings.forEach((f, i) => {
      report += `\n[${i+1}] ${f.severity} â€” ${f.title}\n${'-'.repeat(40)}\nDescription: ${f.description}\nFix: ${f.recommendation}\n`;
    });
  }
  report += `\n${'='.repeat(50)}\nDISCLAIMER: AI-generated. Not a replacement for professional audit.\nAuditAI â€” Free Smart Contract Security Scanner\n`;

  const blob = new Blob([report], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `audit-${date}.txt`; a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showError(msg) {
  const box = document.getElementById('errorBox');
  box.textContent = 'âš  ' + msg;
  box.classList.add('visible');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// â”€â”€â”€ Load shared audit from URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkSharedAudit() {
  const params = new URLSearchParams(window.location.search);
  const auditId = params.get('audit');
  if (!auditId) return;
  const history = getHistory();
  const item = history.find(h => h.id === auditId);
  if (item) {
    lastAuditData = item;
    lastAuditId = item.id;
    renderResults(item, item.id);
    showToast('Shared audit loaded');
  }
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateHistoryCount();
checkSharedAudit();

// Listen for wallet account changes
if (window.ethereum) {
  window.ethereum.on('accountsChanged', (accounts) => {
    if (accounts.length === 0) {
      walletAddress = null;
      document.getElementById('walletBtn').classList.remove('connected');
      document.getElementById('walletLabel').textContent = 'Connect Wallet';
    }
  });
}
</script>
</body>
</html>
